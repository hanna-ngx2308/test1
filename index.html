<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biểu đồ tròn du học sinh 2024</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#fafafa; color:#333; }
    header { padding:20px; background:#004477; color:#fff; }
    .container { max-width: 900px; margin:0 auto; padding:20px; }
    h1 { margin:0; font-size:22px; }
    .panel { background:#fff; border:1px solid #ddd; border-radius:10px; padding:20px; margin-top:20px; }
    canvas { max-height:520px; }
    #legend span{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;border-radius:999px;padding:4px 8px;margin:4px;font-size:13px}
    #legend .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>
<body>
  <header>
    <h1>2024년 주요 국가별 외국인 유학생 현황</h1>
  </header>

  <div class="container">
    <div class="panel">
      <canvas id="chart"></canvas>
      <div id="legend"></div>
    </div>
  </div>

  <script>
  const COLORS = ['#f4b400','#1b6ddc','#b7d5ff','#ff4da6','#0f2b5f','#30c1cb','#9aa0aa'];
  let DATA=[];
  let chart;

  async function loadData(){
    const res = await fetch('data.json', {cache:'no-store'});
    const json = await res.json();
    DATA = json.map((d,i)=>({
      label:d.label, value:+d.value, color:d.color||COLORS[i%COLORS.length]
    }));
    draw(); buildLegend();
  }

  function total(){return DATA.reduce((a,b)=>a+(b.value||0),0)}
  function percents(){
    const t=total(); return DATA.map(d=>t? +(d.value*100/t).toFixed(1):0);
  }

  const PercentLabels = {
    id:'percentLabels',
    afterDatasetDraw(chart,args){
      const {ctx} = chart;
      ctx.save();
      ctx.font='bold 13px Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      const t=total();
      args.meta.data.forEach((el,i)=>{
        const v=DATA[i].value;
        if(v<=0) return;
        const p=(v*100/t);
        if(p<1.5) return;
        const pos=el.tooltipPosition();
        const label=p.toFixed(1)+'%';
        ctx.fillStyle='#000';
        ctx.fillText(label,pos.x,pos.y);
      });
      ctx.restore();
    }
  };

  function draw(){
    const ctx=document.getElementById('chart');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'pie',
      data:{
        labels:DATA.map(d=>d.label),
        datasets:[{data:DATA.map(d=>d.value),backgroundColor:DATA.map(d=>d.color)}]
      },
      options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>{
        const p=percents()[ctx.dataIndex];
        return `${ctx.label}: ${ctx.parsed} (${p}%)`;
      }}}}},
      plugins:[PercentLabels]
    });
  }

  function buildLegend(){
    const legend=document.getElementById('legend');
    const pct=percents();
    legend.innerHTML=DATA.map((d,i)=>`
      <span><span class="dot" style="background:${d.color}"></span>${d.label}: <strong>${pct[i]}%</strong></span>`).join('');
  }

  loadData();
  </script>
</body>
</html>
