<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KR 2024 — International Students by Program Type</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0c0f;--panel:#111317;--ink:#e7e9ee;--muted:#9aa0aa;--ring:rgba(77,163,255,.35)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b0c0f,#0b0c0f 60%,#0e1116);color:var(--ink)}
    header{padding:28px 20px 10px;display:flex;flex-wrap:wrap;align-items:end;gap:16px;max-width:1100px;margin:0 auto}
    h1{margin:0;font-size:20px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 20px 40px}
    .panel{background:var(--panel);border:1px solid #1b1f2a;border-radius:14px;margin-bottom:20px}
    .panel .inner{padding:16px}
    .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #1c2432;background:#0e121a;border-radius:999px;padding:6px 10px;font-size:12px;color:#cfd3db}
    .dot{width:10px;height:10px;border-radius:50%}
    .viz{min-height:420px;display:flex;align-items:center;justify-content:center}
    canvas{max-height:520px}
    footer{max-width:1100px;margin:22px auto 60px;color:var(--muted);font-size:12px;padding:0 20px}
    a{color:#9ecbff}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>KR 2024 — International Students by Program Type</h1>
      <div class="subtitle">Source: <a href="https://www.studyinkorea.go.kr/it/why/koreaStatistics.do" target="_blank">StudyInKorea/KEDI</a> • Data loaded from <code>data.json</code></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="inner">
        <h2 id="chartTitle">KR 2024 — International Students by Program Type</h2>
        <div class="viz"><canvas id="chart"></canvas></div>
        <div id="legend" class="legend"></div>
      </div>
    </section>
  </main>

  <footer>
    This chart automatically loads data from <code>data.json</code>.
  </footer>

<script>
const COLORS = ['#4da3ff','#7dd3fc','#60a5fa','#a78bfa','#fbbf24'];
let DATA=[];
let chart;

async function loadData(){
  try{
    const res = await fetch('data.json', {cache:'no-store'});
    const json = await res.json();
    DATA = json.map((d,i)=>({
      label:d.label, value:+d.value, color:d.color||COLORS[i%COLORS.length]
    }));
    draw(); buildLegend();
  }catch(e){
    alert('Cannot load data.json: '+e.message);
  }
}

function total(){return DATA.reduce((a,b)=>a+(b.value||0),0)}
function percents(){
  const t=total(); return DATA.map(d=>t? +(d.value*100/t).toFixed(1):0);
}

const PercentLabels = {
  id:'percentLabels',
  afterDatasetDraw(chart,args){
    const {ctx} = chart;
    ctx.save();
    ctx.font='bold 13px Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const t=total();
    args.meta.data.forEach((el,i)=>{
      const v=DATA[i].value;
      if(v<=0) return;
      const p=(v*100/t);
      if(p<1.5) return;
      const pos=el.tooltipPosition();
      const label=p.toFixed(1)+'%';
      ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineWidth=3.5; ctx.strokeText(label,pos.x,pos.y);
      ctx.fillStyle='#000'; ctx.fillText(label,pos.x,pos.y);
    });
    ctx.restore();
  }
};

function draw(){
  const ctx=document.getElementById('chart');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'pie',
    data:{
      labels:DATA.map(d=>d.label),
      datasets:[{data:DATA.map(d=>d.value),backgroundColor:DATA.map(d=>d.color)}]
    },
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>{
      const p=percents()[ctx.dataIndex];
      return `${ctx.label}: ${ctx.parsed.toLocaleString('en-US')} (${p}%)`;
    }}}}},
    plugins:[PercentLabels]
  });
}

function buildLegend(){
  const legend=document.getElementById('legend');
  const pct=percents();
  legend.innerHTML=DATA.map((d,i)=>`
    <span class="pill"><span class="dot" style="background:${d.color}"></span>${d.label}: <strong>${pct[i]}%</strong></span>`).join('');
}

loadData();
</script>
</body>
</html>
